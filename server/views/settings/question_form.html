{{ define "settings/question_form.html" }}

{{ template "partials/page_header.html" .}}

<!-- TODO: Move to modal that shows one question form at a time. -->

<h2>Setup Questions</h2>

<p><a target="_blank" href="https://aptrust.github.io/dart-docs/users/settings/export/#export-questions">Need help?</a></p>

<form id="settingsQuestionsForm">

  {{ $settings := .settings }}
  {{ range $index, $question := .settings.Questions }}
    {{ $questionNumber := add $index 1}}
    {{ template "settings/question.html" dict "settings" $settings "questionNumber" $questionNumber "question" $question "form" $question.ToForm }}
  {{ end }} 

</form>


<div class="bottom-buttons">
  <div class="pull-right">
    <a role="button" class="btn btn-primary" id="btnNext" href="#Settings/showExportJson?fromPage=questions">Export</a>
  </div>
  <div class="pull-right mr-3">
      <button type="button" class="btn btn-primary" id="btnAdd">Add Question</button>
  </div>
  <div class="pull-right mr-3">
    <a role="button" class="btn btn-secondary" href="#Settings/saveAndGoToExport">Cancel</a>
  </div>
</div>

<script>
var options = {{ .optionsJson }}
$(function() {

  function loadObjectList(questionId, objType) {
    let objIdList = $(`select[data-control-name="objId"][data-question-id="${questionId}"]`)
    let listOptions = []
    switch (objType) {
      case "AppSetting":
        listOptions = options.appSettings
        break
      case "BagItProfile":
        listOptions = options.bagItProfiles
        break
      case "RemoteRepository":
        listOptions = options.remoteRepositories
        break
      case "StorageService":
        listOptions = options.storageServices
        break
    }
    objIdList.empty()
    objIdList.append(new Option(""))
    listOptions.forEach(function(item) {
      objIdList.append(new Option(item.Name, item.ID))
    })
  }

  // When ObjType changes, load obj list
  $('select[data-control-name="objType"]').on('change', function() {
    let questionId = $(this).data('question-id') 
    let objType = $(this).val()
    if (objType) {
      loadObjectList(questionId, objType)
    }
  })
  
  // When ObjID changes, load field list
  $('select[data-control-name="objId"]').on('change', function() {
    let questionId = $(this).data('question-id') 
    let objectId = $(this).val()
    let objType = $(`select[data-control-name="objType"][data-question-id="${questionId}"]`).val()
    let fieldList = $(`select[data-control-name="field"][data-question-id="${questionId}"]`)
    let selectedField = fieldList.val()
    let listOptions = []
    fieldList.empty()
    fieldList.append(new Option(""))
    switch (objType) {
      case "AppSetting":
        listOptions = options.appSettingFields
        break
      case "BagItProfile":
        // Get options for the SELECTED profile.
        listOptions = options.bagItProfileFields[objectId]
        listOptions.forEach(function(item) {
          var opt = new Option(item.Name, item.ID)
          if (item == selectedField) {
            opt.selected = true
          }
          fieldList.append(opt)
        })
        return
      case "RemoteRepository":
        listOptions = options.remoteRepositoryFields
        break
      case "StorageService":
        listOptions = options.storageServiceFields
        break
    }
    listOptions.forEach(function(item) {
      var opt = new Option(item, item)
      if (item == selectedField) {
        opt.selected = true
      }
      fieldList.append(opt)
    })
  })
})
</script>

{{ template "partials/page_footer.html" .}}

{{ end }}