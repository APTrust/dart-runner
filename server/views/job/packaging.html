{{ define "job/packaging.html" }}

{{ template "partials/page_header.html" .}}

<h2>Packaging</h2>

<!--
<p>
    Note: Although this page displays a number of serialization formats,
    DART currently supports only the "None" and ".tar" formats. Additional
    formats will be coming soon.
</p>
-->

<!-- { {> bannerAlert message = alertMessage } } -->

<form method="post" action="/jobs/packaging/{{ .job.ID }}" id="{{ .job.ID }}">

  <div style="display: {{ if .job.WorkflowID }} none {{ else }} block {{ end }};">
    {{ template "partials/input_select.html" dict "field" .form.Fields.PackageFormat }}

    <!-- div id="jobProfileContainer" style='display: {{if eq "BagIt" .form.Fields.PackageFormat.Value }} block {{ else }} none {{ end }};' -->
    <div id="jobProfileContainer" style='display:block;'>
        {{ template "partials/input_select.html" dict "field" .form.Fields.BagItProfileID }}
        {{ template "partials/input_select.html" dict "field" .form.Fields.BagItSerialization }}
    </div>
  </div>


  {{ template "partials/input_text.html" dict "field" .form.Fields.PackageName }}

  {{ template "partials/input_text.html" dict "field" .form.Fields.OutputPath }}

  {{ template "partials/input_hidden.html" dict "field" .form.Fields.ID }}

  <input type="hidden" name="direction" value="next"/>


  <div class="float-left" id="btnBackDiv">
    <button type="submit" onclick="document.forms['{{ .job.ID }}'].direction.value='previous'" class="btn btn-primary" role="button">&lt;&lt; Back</button>
  </div>
  
  <div class="float-right" id="btnNextDiv">
    <button type="submit" onclick="document.forms['{{ .job.ID }}'].direction.value='next'" class="btn btn-primary" role="button">Next &gt;&gt;</button>
  </div>
  

</form>

<script>
$(function() {

  let baggingDir = {{ .baggingDir }}
  let separator = {{ .pathSeparator }}
  let autoSetSerialization = {{ .autoSetSerialization }}
  let serializationRequired = {{ .serializationRequired }}
  let emptySerializationOption = 'none (bag as directory)'

  let extensionForType = {
    "application/x-7z-compressed": ".7z",
    "application/tar": ".tar",
    "application/x-tar": ".tar",
    "application/zip": ".zip",
    "application/gzip": ".gz",
    "application/x-rar-compressed": ".rar",
    "application/tar+gzip": ".tgz"
  }

  function setOutputPath() {
    var packageName = $('#Job_PackageName').val()
    var mimeType = $('#Job_BagItSerialization').val();
    var extension = extensionForType[mimeType] || ''
    if (packageName && !packageName.endsWith(extension)) {
      packageName += extension;
    }
    // In case user switched to a package format that's not serialized.
    if (extension == '') {
      packageName = packageName.replace(/\.\w+$/, '')
    }
    $('#Job_OutputPath').val(`${baggingDir}${separator}${packageName}`)
  }
  $('#Job_PackageName').on('keyup', setOutputPath)
  $('#Job_BagItSerialization').on('change', setOutputPath)

  function setSerialization() {
    let profileId = $('#Job_BagItProfileID').val()
    if (serializationRequired.includes(profileId)) {
      // Don't show empty serialization option because serializion 
      // is required for this profile.
      removeEmptySerializationOption()
    } else {
      addEmptySerializationOption()
    }
    let serializationFormat = autoSetSerialization[profileId]
    $('#Job_BagItSerialization').val(serializationFormat)
  }

  function listHasEmptySerializationOption() {
    var hasOption = false
    $('#Job_BagItSerialization option').each(function(opt) {
      if ($(this).val() == emptySerializationOption) {
        hasOption = true
      }
    })
    return hasOption
  }
  function addEmptySerializationOption() {
    if (!listHasEmptySerializationOption()) {
      var option = `<option value='${emptySerializationOption}'>${emptySerializationOption}</option>`
      $(option).insertAfter($('#Job_BagItSerialization option')[0])
    }
  }
  function removeEmptySerializationOption() {
    if (listHasEmptySerializationOption()) {
      var option = $('#Job_BagItSerialization option[value="none (bag as directory)"]')
      $(option).remove()
    }
  }

  // Run this once on page load, then attach it to the profile
  // select list so we can watch for changes.
  setSerialization()
  $('#Job_BagItProfileID').on('change', setSerialization)

})
</script>

{{ template "partials/page_footer.html" .}}

{{ end }}