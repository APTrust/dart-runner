{{ define "job/list.html" }}

{{ template "partials/page_header.html" .}}

<h2>Jobs</h2>
<div class="float-right mt-1 mb-3">
  <a class="btn btn-primary" href="/jobs/new" role="button">New</a>
</div>
<table class="table table-hover">
  <thead class="thead-inverse">
    <tr>
      <th>Name</th>
      <th>Status</th>
      <th>Artifacts</th>
      <th>&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    {{ range $index, $item := .items }}
    <tr>
      <td><a href="/jobs/files/{{ $item.Job.ID }}">{{ $item.Job.Name }}</a></td>
      <td>
        {{ displayDate $item.Job.Outcome.LastActivity}}<br/>
        
        <!-- Packaging Info -->
        {{ if $item.Job.PackageAttempted }}
          {{ if $item.Job.PackageSucceeded }}
            <i class="fa fa-check mr-2" aria-hidden="true" style="color: green;"></i> Packaged 
              {{ if $item.Job.Outcome.BagItProfileName }}
              with profile {{ $item.Job.Outcome.BagItProfileName }} 
              {{ end }}
              <br/>
          {{ else }}
            <i class="fa fa-times mr-2" aria-hidden="true" style="color: red;"></i> Packaging failed <br/>
          {{ end }}
        {{ end }}

        <!-- Validation Info -->
        {{ if $item.Job.ValidationAttempted }}
          {{ if $item.Job.ValidationSucceeded }}
            <i class="fa fa-check mr-2" aria-hidden="true" style="color: green;"></i> Validation succeeded <br/>
          {{ else }}
            <i class="fa fa-times mr-2" aria-hidden="true" style="color: red;"></i> Validation failed <br/>
          {{ end }}
        {{ end }}

        <!-- Upload info -->
        {{ range $a, $uploadTarget := $item.Job.Outcome.SuccessfulUploads }}
          <i class="fa fa-check mr-2" aria-hidden="true" style="color: green;"></i> Uploaded to {{ $uploadTarget }} <br/>
        {{ end }}
        {{ range $a, $uploadTarget := $item.Job.Outcome.FailedUploads }}
          <i class="fa fa-times mr-2" aria-hidden="true" style="color: red;"></i>  Upload to {{ $uploadTarget }} failed <br/>
        {{ end }}
        {{ $item.Job.Outcome.Message }}
      </td>
      <td>
        {{ if $item.Job.Outcome.JobWasRun }}
        <div class="form-group ">
          <select class="form-control" data-action="show-artifact" data-job-name="{{ $item.Job.Name }}">
            <option value="">-- View Artifact --</option>
            {{ range $i, $artifact := $item.Artifacts }}
            <option value="{{ $artifact.ID }}">{{ $artifact.Name }}</option>
            {{ end }}
          </select>
        </div>
        {{ end }}
      </td>
      <td><a href="javascript:confirmForegroundDeletion('Delete job {{ $item.Job.Name }}?', '/jobs/delete/{{ $item.Job.ID }}')" title="Delete job {{ $item.Job.Name }}"><i class="fa fa-times text-danger" aria-hidden="true"></i></a></td>
    </tr>
    {{ end }}
  </tbody>
</table>

{{ template "partials/table_bottom_links.html" . }}


{{ template "partials/pager.html" . }}

<script>
$(function(){
  $('select[data-action="show-artifact"]').on("change", function(){
    let artifactId = $(this).val()
    if (artifactId != "") {
      let url = `/jobs/artifact/${artifactId}`
      loadIntoModal('get', 'Job Artifact', url)
    }
  })
})
</script>

{{ template "partials/page_footer.html" .}}

{{ end }}
