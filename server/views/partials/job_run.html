{{ define "partials/job_run.html" }}

<!--

This template, and the script that appears below the HTML, is used 
in both the "job run" UI and the "run workflow batch" UI.

We fill in this info via the JobSummary object that the back end
passes through in the Init Event (server-sent event). JavaScript
on the front end parses the JobSummary and inserts data into the
divs and spans below. See the IDs of the divs and spans to get
an idea of what goes into them.

-->


<div class="row mb-1" id="packageOpDiv" style="display:none">
  <div class="col text-right font-weight-bold">Package Name</div>
  <div class="col-10" id="packageName"></div>
</div>

<div class="row mb-1" id="bagItProfileDiv" style="display:none">
  <div class="col text-right font-weight-bold">BagIt Profile</div>
  <div class="col-10">
    <span id="bagItProfileName"></span> <br/>
    <span id="bagItProfileDescription"></span>
  </div>
</div>

<div class="row mb-1" id="payloadSummaryDiv" style="display:none">
  <div class="col text-right font-weight-bold">Payload Summary</div>
  <div class="col-10">
    <span id="directoryCount"></span> Directories <br/>
    <span id="fileCount"></span> Files <br/>
    <span id="byteCountHuman"></span> (<span id="byteCountFormatted"></span> bytes)<br/>
  </div>
</div>

<div class="row mb-1" id="sourceFilesDiv" style="display:none">
  <div class="col text-right font-weight-bold">Files to Package</div>
  <div class="col-10">
    <ul id="sourceFiles" class="flush-no-marker"></ul>
  </div>
</div>

<div class="row mb-1" id="outputPathDiv" style="display:none">
  <div class="col text-right font-weight-bold">Output Path</div>
  <div class="col-10"><div id="outputPathLink" data-url=""></div></div>
</div>

<div class="row mb-1" id="uploadOpsDiv" style="display:none">
  <div class="col text-right font-weight-bold">Upload To</div>
  <div class="col-10">
    <ul id="uploadTargets" class="flush-no-marker"></ul>
  </div>
</div>

<div class="row" id="jobIdContainer" style="display:none;">
  {{ template "partials/dart_process.html" .jobSummary }}
</div>




<script>

    // These vars are set dynamically by the back end.
    // TODO: In batch workflow, allow dynamic vars to be
    // passed as JSON through Server-Sent Events.
    //
    // Just send this from the backend, period. 
    //
    // For workflows, on each new job, reset display
    // and call runJob(jobId). We also need a way to 
    // display workflow validation errors and workflow
    // results (red x or green check next to each item).
    var completedUploads = []
    var weAreRunningAWorkflowBatch = false 
    var settings = {}

    // This will be empty for workflow batches, but on the job_run
    // page this lets us display the job details as soon as the
    // page loads. If we have jobSummaryJson, we'll also make a
    // call to showJobDetails() in the page load event at the
    // bottom of this file. See below.
    {{ if .jobSummaryJson }}
    settings = JSON.parse({{ .jobSummaryJson }});
    {{ end }}

    function runJob(eventSourceUrl, jobId) {

      // The general pattern SSE listener pattern is:
      //
      // sse.addEventListener("eventName", (e) => { code... });
      // 
      if (jobId && !eventSourceUrl.endsWith("/")) {
        eventSourceUrl += "/"
      }
      if (eventSourceUrl.includes("/workflows")) {
        weAreRunningAWorkflowBatch = true
        // User may be re-running batch; remove previous result messages.
        $('#workflowResults').remove('div.batch-result')
        $('#batchRunning').show();
        $('#workflowResults').show();
        $('div.batch-result').remove();
      }
      let eventSrc = new EventSource(eventSourceUrl + jobId)
        eventSrc.onmessage = (event) => {
          //console.log(event)
          if (!event.data) {
            console.log("Malformed message")
            console.log(event)
            return
          }
          var data
          try {
            data = JSON.parse(event.data)
          } catch (ex) {
            console.log(ex)
            console.log(event)
            return
          }

          if (data.eventType == "init") {
            console.log(`Got init event for job ${data.jobSummary.id}`)
            settings = data.jobSummary
            console.log(settings)
            showJobDetails()
            showProgressDivs()
          } else if (data.eventType == "disconnect") {
            console.log("Received disconnect from server")
            console.log(data.message)
            eventSrc.close()
          } else {
            renderInfo(data)
          }
        }
        eventSrc.onerror = (event) => {
          console.error(event)
        }
    }

    function showJobDetails() {
      $('#jobName').html(settings.Name)
      clearAndHidePackagingInfo()
      if (settings.hasPackageOp) {
        showPackagingInfo()
      } 
      $('#uploadTargets').empty()
      if (settings.hasUploadOps) {
        $('#uploadOpsDiv').show()
        for (let item of settings.uploadTargets) {
          $('#uploadTargets').append(`<li>${item}</li>`)
        }
      } else {
        $('#uploadOpsDiv').hide()
        $('#uploadTargets').empty()
      }
    }

    function clearAndHidePackagingInfo() {
        $('#packageOpDiv').hide()
        $('#bagItProfileDiv').hide()
        $('#payloadSummaryDiv').hide()
        $('#sourceFilesDiv').hide()
        $('#outputPathDiv').hide()

        $('#packageName').empty()
        $('#bagItProfileName').empty()
        $('#bagItProfileDescription').empty()
        $('#directoryCount').empty()
        $('#fileCount').empty()
        $('#byteCountHuman').empty()
        $('#byteCountFormatted').empty()
        $('#outputPathLink').empty()
        $('#sourceFiles').empty()
    }

    function showPackagingInfo() {
        $('#packageName').html(settings.packageName)
        $('#bagItProfileName').html(settings.bagItProfileName)
        $('#bagItProfileDescription').html(settings.bagItProfileDescription)
        $('#directoryCount').html(settings.directoryCount)
        $('#fileCount').html(settings.fileCount)
        $('#byteCountHuman').html(settings.byteCountHuman)
        $('#byteCountFormatted').html(settings.byteCountFormatted)
        $('#outputPathLink').html(settings.outputPath)

        for (let item of settings.sourceFiles) {
          $('#sourceFiles').append(`<li>${item}</li>`)
        }

        $('#packageOpDiv').show()
        $('#bagItProfileDiv').show()
        $('#payloadSummaryDiv').show()
        $('#sourceFilesDiv').show()
        $('#outputPathDiv').show()
    }

    function showProgressDivs() {
        let processDiv = $('#jobIdContainer');
        if (settings.hasPackageOp) {
            initProgressBar('packageInfo');
            $(`#runningJobDisplay div.packageInfo`).show();
            if (settings.packageFormat == 'BagIt') {
                initProgressBar('validationInfo');
                $(`#runningJobDisplay div.validationInfo`).show();
            }
        }
        if (settings.hasUploadOps) {
            initProgressBar('uploadInfo');
            $(`#runningJobDisplay div.uploadInfo`).show();
        }
        $(`#job-start-time`).text(new Date().toLocaleString());
        processDiv.show();
    }

    function renderInfo(data) {
      let section = data.stage + "Info"
      var [detailDiv, progressBar] = getDivs(section);
      // A job can include multiple uploads. For each new
      // upload, we want to set the progress bar back to 
      // zero and render it in blue.
      if (data.eventType == "start") {
        initProgressBar('uploadInfo')
      }
      if (data.eventType == "finish") {
        console.log(data)
        if (data.status == "success") {
          if (section == "") {
            completedUploads.push(data.message)
            markSuccess(detailDiv, progressBar, completedUploads.join("<br/>\n"))
          } else {
            markSuccess(detailDiv, progressBar, data.message)
          }
          activateOutputPathLink()
          showBatchJobSucceeded(data)
        } else if (data.status == "failed") { 
          // Finish with error. Note that detail div here is the outcome
          // div, not the div for the current stage, because job has finished.
          detailDiv = $(`#runningJobDisplay div.outcome div.detail div.message`);
          markFailed(detailDiv, progressBar, getErrorsAsHTML(data))
          showBatchJobFailed(data)
        }
      } else { // info message
        detailDiv.text(data.message)
        setProgressBar(progressBar, data);
      }
      // If we're running a workflow batch, we need to reset
      // this for the next job.
      if (weAreRunningAWorkflowBatch) {
          completedUploads = []
      }
    }

    function getDivs(section) {
        let selectorPrefix = `#runningJobDisplay div.${section} div.detail`;
        let detailDiv = $(`${selectorPrefix} div.message`);
        let progressBar = $(`${selectorPrefix} div.progress-bar`);
        return [detailDiv, progressBar];
    }

    function initProgressBar(section) {
        let [_, progressBar] = getDivs(section);
        if (progressBar) {
            progressBar.removeClass("bg-success");
            progressBar.removeClass("bg-danger");
            let initialClasses = ["progress-bar-striped", "progress-bar-animated"];
            for (let cssClass of initialClasses) {
                if (progressBar.hasClass(cssClass)) {
                    progressBar.addClass(cssClass);
                }
            }
            data = { percent: 0 }
            setProgressBar(progressBar, data)
        }
    }

    function setProgressBar(progressBar, data) {
        // Sometimes the data object does not include percentComplete,
        // and when percentComplete is unknown, it's set to -1.
        if (isNaN(data.percent) || data.percent < 0) {
            return;
        }
        // In bag creation, progress bar hits 100% when all payload
        // files are added. We have to add tag files and manifests
        // afterward, and we don't want the bar to bounce, so no
        // changes after it reaches 100%.
        //
        // Similarly with validation, the bar hits 100% when all checksums
        // have been verified, but the validator still has a few remaining
        // tasks, including tag file validation.
        //
        // In both cases, the bar will stick at 100% for a second or two.
        // When all items are complete, the bar animation will stop and
        // the bar will turn green.
        if (parseInt(progressBar.attr("aria-valuenow"), 10) != 100) {
            progressBar.attr("aria-valuenow", data.percent);
            progressBar.css("width", data.percent + '%');
        }
    }

    function markSuccess(detailDiv, progressBar, message) {
        detailDiv.html(message);
        if (progressBar) {
            setProgressBar(progressBar, { percent: 100 });
            progressBar.removeClass("progress-bar-striped progress-bar-animated");
            progressBar.addClass("bg-success");
        }
    }

    function markFailed(detailDiv, progressBar, message) {
        detailDiv.html(message);
        if (progressBar) {
            progressBar.removeClass("progress-bar-striped progress-bar-animated");
            progressBar.attr("aria-valuenow", 100);
            progressBar.css("width", '100%');
            progressBar.addClass("bg-danger");
        }
    }

    function getErrorsAsHTML(data) {
      var result = data.jobResult
      if (!result) {
        return "<p>Cannot get error details from job result.</p>"
      }
      var html = ""
      if (result.packageResult && result.packageResult.errors && Object.values(result.packageResult.errors).length > 0) {
        html += "<h3>Packaging Errors</h3><ol>"
        Object.values(result.packageResult.errors).forEach(function(errMessage) {
          html += `<li>${errMessage}</li>`
        })
        html += "</ol>"
      }
      if (result.validationResult && result.validationResult.errors && Object.values(result.validationResult.errors).length > 0) {
        html += "<h3>Validation Errors</h3><ol>"
        Object.values(result.validationResult.errors).forEach(function(errMessage) {
          html += `<li>${errMessage}</li>`
        })
        html += "</ol>"
      }
      if (result.uploadResults) {
        result.uploadResults.forEach(function(uploadResult) {
          if (uploadResult.errors && Object.values(uploadResult.errors).length > 0) {
            html += `<h3>Upload Errors (${uploadResult.remoteURL})</h3><ol>`
            Object.values(uploadResult.errors).forEach(function(errMessage) {
              html += `<li>${errMessage}</li>`
            })
            html += "</ol>"
          }
        })
      }
      return html
    }

    function activateOutputPathLink() {
      var div = $('#outputPathLink')
      //var url = div.data('url') // Get this from JobSummary instead
      var url = settings.outputPath
      var dir = url.split(settings.pathSeparator).slice(0, -1).join(settings.pathSeparator)
      console.log(dir)
      var html = `<a href="javascript:openExternalUrl('${dir}')">${url}</a>`
      div.html(html)
    }


    function showBatchJobSucceeded(data) {
        if (weAreRunningAWorkflowBatch) {
        let html = `<div class="row batch-result" id=""><i class="fa fa-check mr-2" aria-hidden="true" style="color: green;"></i> Line 1 - RunnerTestCore</div>`
          $('#workflowResults').append(html)
        }
    }

    function showBatchJobFailed(data) {
        if (weAreRunningAWorkflowBatch) {
          let html = `
          <div class="row batch-result" id="[JOB ID HERE]">
            <i class="fa fa-times mr-2" aria-hidden="true" style="color: red;"></i> 
              Line 1 - RunnerTestCore
            <ul>
              <li class="text-danger">Error list item</li>
            </ul>
          </div>`
          $('#workflowResults').append(html)
        }
    }


    $(function(){
    {{ if .jobSummaryJson }}
      showJobDetails()
    {{ end }}
    })
</script>

{{ end }}
